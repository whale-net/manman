name: OpenAPI

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*'
  pull_request:
    branches:
      - 'main'

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  actions: write
  issues: write
  pull-requests: write


jobs:
  generate-openapi:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for release attachment
      actions: write   # Required for artifact upload
      issues: write    # Required for PR comments

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.7.8"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install the project
        run: uv sync

      - name: Create OpenAPI specs directory
        run: mkdir -p openapi-specs

      - name: Generate OpenAPI spec for Experience API
        run: uv run openapi experience-api

      - name: Generate OpenAPI spec for Status API
        run: uv run openapi status-api

      - name: Generate OpenAPI spec for Worker DAL API
        run: uv run openapi worker-dal-api

      - name: List generated files
        run: |
          echo "Generated OpenAPI specifications:"
          ls -la openapi-specs/
          echo
          echo "File contents preview:"
          for file in openapi-specs/*.json; do
            echo "=== $file ==="
            jq '.info.title, .info.version' "$file" 2>/dev/null || echo "Failed to parse JSON"
            echo
          done

      - name: Create OpenAPI bundle
        run: |
          # Create a combined archive with all OpenAPI specs
          tar -czf openapi-specs-bundle.tar.gz openapi-specs/

          # Also create individual archives for each API
          cd openapi-specs
          for api_file in *.json; do
            api_name=$(basename "$api_file" .json)
            tar -czf "../openapi-${api_name}.tar.gz" "$api_file"
          done
          cd ..

      - name: Upload OpenAPI artifacts (for all events)
        uses: actions/upload-artifact@v4
        with:
          name: openapi-specifications
          path: |
            openapi-specs/
            openapi-*.tar.gz
          retention-days: 30

      # Only attach to release if this is a tag push
      - name: Attach OpenAPI specs to release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            openapi-specs-bundle.tar.gz
            openapi-*.tar.gz
            openapi-specs/*.json
          body: |
            ## OpenAPI Specifications

            This release includes OpenAPI specifications for all ManMan APIs:

            - **experience-api.json**: Experience API (host layer) - Game server management and user-facing functionality
            - **status-api.json**: Status API - Status and monitoring functionality
            - **worker-dal-api.json**: Worker DAL API - Data access endpoints for worker services

            ### Usage

            You can use these specifications to:
            - Generate client SDKs using tools like OpenAPI Generator
            - Import into API testing tools like Postman or Insomnia
            - Generate documentation using tools like Redoc or Swagger UI
            - Validate API contracts in your integration tests

            ### Formats Available

            - Individual JSON files: `experience-api.json`, `status-api.json`, `worker-dal-api.json`
            - Individual archives: `openapi-experience-api.tar.gz`, etc.
            - Complete bundle: `openapi-specs-bundle.tar.gz` (contains all specifications)

  # Additional job to validate the generated OpenAPI specs
  validate-openapi:
    runs-on: ubuntu-latest
    needs: generate-openapi
    if: always() && needs.generate-openapi.result == 'success'

    steps:
      - name: Download OpenAPI artifacts
        uses: actions/download-artifact@v4
        with:
          name: openapi-specifications

      - name: Install OpenAPI validation tools
        run: |
          npm install -g @apidevtools/swagger-parser
          npm install -g @redocly/openapi-cli

      - name: Validate OpenAPI specifications
        run: |
          echo "ðŸ” Validating OpenAPI specifications..."

          for spec_file in openapi-specs/*.json; do
            echo "Validating $spec_file..."

            # Validate with swagger-parser
            echo "  ðŸ“‹ Swagger Parser validation:"
            swagger-parser validate "$spec_file" || echo "  âš ï¸ Swagger Parser validation failed"

            # Validate with Redocly CLI
            echo "  ðŸ“‹ Redocly validation:"
            redocly lint "$spec_file" || echo "  âš ï¸ Redocly validation failed"

            echo "  âœ… Validation completed for $spec_file"
            echo
          done

          echo "ðŸŽ‰ All OpenAPI specifications have been validated!"

      - name: Generate documentation preview
        run: |
          echo "ðŸ“š Generating documentation previews..."

          # Install the new Redocly CLI (redoc-cli is deprecated)
          npm install -g @redocly/cli

          mkdir -p docs-preview

          for spec_file in openapi-specs/*.json; do
            api_name=$(basename "$spec_file" .json)
            echo "Generating docs for $api_name..."
            npx @redocly/cli build-docs "$spec_file" --output "docs-preview/${api_name}.html"
          done

          echo "ðŸ“ Generated documentation files:"
          ls -la docs-preview/

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openapi-documentation
          path: docs-preview/
          retention-days: 30

  # Deploy documentation to GitHub Pages
  deploy-docs:
    runs-on: ubuntu-latest
    needs: validate-openapi
    if: always() && needs.validate-openapi.result == 'success'
    permissions:
      contents: read
      pages: write
      id-token: write
      pull-requests: write  # For PR comments

    # Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
    # However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
    concurrency:
      group: "pages-${{ github.event_name }}-${{ github.ref }}"
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download OpenAPI documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: openapi-documentation
          path: docs-preview

      - name: Create index page
        run: |
          cat > docs-preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ManMan API Documentation</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 2rem;
                      background: #f8fafc;
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 3rem;
                      padding-bottom: 2rem;
                      border-bottom: 2px solid #e2e8f0;
                  }
                  .api-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 2rem;
                      margin-top: 2rem;
                  }
                  .api-card {
                      background: white;
                      border-radius: 12px;
                      padding: 2rem;
                      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                      border: 1px solid #e2e8f0;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .api-card:hover {
                      transform: translateY(-2px);
                      box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
                  }
                  .api-title {
                      font-size: 1.5rem;
                      font-weight: 600;
                      margin-bottom: 1rem;
                      color: #1e293b;
                  }
                  .api-description {
                      color: #64748b;
                      margin-bottom: 1.5rem;
                      line-height: 1.6;
                  }
                  .api-link {
                      display: inline-block;
                      background: #3b82f6;
                      color: white;
                      padding: 0.75rem 1.5rem;
                      border-radius: 8px;
                      text-decoration: none;
                      font-weight: 500;
                      transition: background 0.2s;
                  }
                  .api-link:hover {
                      background: #2563eb;
                  }
                  .build-info {
                      background: #f1f5f9;
                      border-radius: 8px;
                      padding: 1rem;
                      margin-top: 2rem;
                      font-size: 0.875rem;
                      color: #475569;
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ManMan API Documentation</h1>
                  <p>Interactive API documentation for all ManMan services</p>
              </div>

              <div class="api-grid">
                  <div class="api-card">
                      <h2 class="api-title">Experience API</h2>
                      <p class="api-description">Game server management and user-facing functionality. This is the primary API for hosting game servers and managing user experiences.</p>
                      <a href="experience-api.html" class="api-link">View Documentation</a>
                  </div>

                  <div class="api-card">
                      <h2 class="api-title">Status API</h2>
                      <p class="api-description">Status and monitoring functionality. Provides health checks, metrics, and monitoring endpoints for all ManMan services.</p>
                      <a href="status-api.html" class="api-link">View Documentation</a>
                  </div>

                  <div class="api-card">
                      <h2 class="api-title">Worker DAL API</h2>
                      <p class="api-description">Data access endpoints for worker services. Internal API used by worker processes for database operations.</p>
                      <a href="worker-dal-api.html" class="api-link">View Documentation</a>
                  </div>
              </div>

              <div class="build-info">
                  <strong>Build Information:</strong><br>
                  Generated from commit: <code>${{ github.sha }}</code><br>
                  Branch/Tag: <code>${{ github.ref_name }}</code><br>
                  Event: <code>${{ github.event_name }}</code><br>
                  Generated at: <code>$(date -u)</code>
              </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-preview

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Comment on PR with documentation link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const deploymentUrl = '${{ steps.deployment.outputs.page_url }}';

            const body = `## ðŸ“š API Documentation Preview

            The OpenAPI documentation has been generated and deployed for this PR.

            **ðŸ“– View Documentation:** ${deploymentUrl}

            ### Available APIs:
            - [Experience API](${deploymentUrl}experience-api.html) - Game server management
            - [Status API](${deploymentUrl}status-api.html) - Monitoring and health checks
            - [Worker DAL API](${deploymentUrl}worker-dal-api.html) - Data access layer

            *Documentation is automatically updated with each commit to this PR.*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number,
            });

            const existingComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ðŸ“š API Documentation Preview')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existingComment.id,
                body,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body,
              });
            }
